// Load the stored playback state from localStorage
function loadStoredState() {
  const storedFiles = JSON.parse(localStorage.getItem('audioFiles'));
  const savedIndex = localStorage.getItem('currentIndex');
  storedTime = parseFloat(localStorage.getItem('storedTime')) || 0;

  if (storedFiles && savedIndex !== null) {
    // Match stored files with loaded files for syncing
    const storedFileNames = storedFiles.join(',');
    const loadedFileNames = audioFiles.map(file => file.name).join(',');

    if (storedFileNames === loadedFileNames) {
      currentIndex = parseInt(savedIndex, 10);
      info.textContent = "Playback state restored.";
      return true;
    } else {
      info.textContent = "Loaded files do not match previously saved session.";
    }
  }
  return false;
}

// Load and play the current file
function loadAndPlay(index, syncToStoredTime = false) {
  if (index >= 0 && index < audioFiles.length) {
    const file = audioFiles[index];
    const fileURL = URL.createObjectURL(file);
    audioElement.src = fileURL;

    audioElement.addEventListener('loadeddata', () => {
      if (syncToStoredTime && index === currentIndex) {
        audioElement.currentTime = storedTime; // Sync to stored time only on initial load
      } else {
        audioElement.currentTime = 0; // Always start new files at the beginning
      }
      audioElement.play();
      info.textContent = `Now playing: ${file.name}`;
      
      startSavingPlaybackState();
    }, { once: true });
  }
}

// Ensure playback resumes with the correct file and time
window.onload = () => {
  if (audioFiles.length === 0) {
    const storedFiles = JSON.parse(localStorage.getItem('audioFiles'));
    if (storedFiles) {
      storedFiles.forEach(name => {
        // Create dummy File object placeholders (for testing purposes)
        audioFiles.push(new File([new Blob()], name));
      });

      if (loadStoredState()) {
        loadAndPlay(currentIndex, true); // Load with syncing to the saved state
      }
    }
  }
};
